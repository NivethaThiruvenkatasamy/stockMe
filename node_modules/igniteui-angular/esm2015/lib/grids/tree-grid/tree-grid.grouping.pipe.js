import { Pipe } from '@angular/core';
import { GridColumnDataType } from '../../data-operations/data-util';
import { IgxSorting } from '../../data-operations/sorting-strategy';
const HIDDEN_FIELD_NAME = '_Igx_Hidden_Data_';
/**
 * @hidden
 * @internal
 */
class GroupByRecord {
}
export class ITreeGridAggregation {
}
export class IgxGroupedTreeGridSorting extends IgxSorting {
    static instance() {
        return this._instance || (this._instance = new IgxGroupedTreeGridSorting());
    }
    getFieldValue(obj, key, isDate = false, isTime = false) {
        return obj.data[HIDDEN_FIELD_NAME] ?
            super.getFieldValue(obj.data[HIDDEN_FIELD_NAME], key, isDate, isTime) :
            super.getFieldValue(obj.data, key, isDate, isTime);
    }
}
IgxGroupedTreeGridSorting._instance = null;
/** @hidden */
export class IgxTreeGridGroupingPipe {
    transform(collection, groupingExpressions, groupKey, childDataKey, grid, aggregations) {
        if (groupingExpressions.length === 0) {
            return collection;
        }
        if ((groupKey === null || groupKey === void 0 ? void 0 : groupKey.toLowerCase()) === (childDataKey === null || childDataKey === void 0 ? void 0 : childDataKey.toLowerCase())) {
            throw new Error('Group key and child data key cannot be the same.');
        }
        this.grid = grid;
        const result = [];
        const groupedRecords = this.groupByMultiple(collection, groupingExpressions);
        this.flattenGrouping(groupedRecords, groupKey, childDataKey, result, aggregations);
        return result;
    }
    flattenGrouping(groupRecords, groupKey, childDataKey, data, aggregations = []) {
        for (const groupRecord of groupRecords) {
            const parent = {};
            const children = groupRecord.records;
            parent[childDataKey] = [];
            for (const aggregation of aggregations) {
                parent[aggregation.field] = aggregation.aggregate(parent, children);
            }
            parent[groupKey] = groupRecord.value + ` (${groupRecord.records.length})`;
            parent[HIDDEN_FIELD_NAME] = { [groupRecord.key]: groupRecord.value };
            data.push(parent);
            if (groupRecord.groups) {
                this.flattenGrouping(groupRecord.groups, groupKey, childDataKey, parent[childDataKey], aggregations);
            }
            else {
                parent[childDataKey] = children;
            }
        }
    }
    groupByMultiple(array, groupingExpressions, index = 0) {
        const res = this.groupBy(array, groupingExpressions[index]);
        if (index + 1 < groupingExpressions.length) {
            for (const groupByRecord of res) {
                groupByRecord.groups = this.groupByMultiple(groupByRecord.records, groupingExpressions, index + 1);
            }
        }
        return res;
    }
    groupBy(array, groupingExpression) {
        var _a;
        const key = groupingExpression.fieldName;
        const column = (_a = this.grid) === null || _a === void 0 ? void 0 : _a.getColumnByName(key);
        const isDateTime = (column === null || column === void 0 ? void 0 : column.dataType) === GridColumnDataType.Date ||
            (column === null || column === void 0 ? void 0 : column.dataType) === GridColumnDataType.DateTime ||
            (column === null || column === void 0 ? void 0 : column.dataType) === GridColumnDataType.Time;
        const map = new Map();
        for (const record of array) {
            const value = isDateTime
                ? this.grid.datePipe.transform(record[key])
                : record[key];
            let groupByRecord;
            if (map.has(value)) {
                groupByRecord = map.get(value);
            }
            else {
                groupByRecord = new GroupByRecord();
                groupByRecord.key = key;
                groupByRecord.value = value;
                groupByRecord.records = [];
                map.set(value, groupByRecord);
            }
            groupByRecord.records.push(record);
        }
        return Array.from(map.values());
    }
}
IgxTreeGridGroupingPipe.decorators = [
    { type: Pipe, args: [{
                name: 'treeGridGrouping'
            },] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJlZS1ncmlkLmdyb3VwaW5nLnBpcGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9pZ25pdGV1aS1hbmd1bGFyL3NyYy9saWIvZ3JpZHMvdHJlZS1ncmlkL3RyZWUtZ3JpZC5ncm91cGluZy5waXBlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxJQUFJLEVBQWlCLE1BQU0sZUFBZSxDQUFDO0FBQ3BELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBRXJFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUdwRSxNQUFNLGlCQUFpQixHQUFHLG1CQUFtQixDQUFDO0FBRTlDOzs7R0FHRztBQUNILE1BQU0sYUFBYTtDQUtsQjtBQUVELE1BQU0sT0FBTyxvQkFBb0I7Q0FHaEM7QUFFRCxNQUFNLE9BQU8seUJBQTBCLFNBQVEsVUFBVTtJQUc5QyxNQUFNLENBQUMsUUFBUTtRQUNsQixPQUFPLElBQUksQ0FBQyxTQUFTLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUkseUJBQXlCLEVBQUUsQ0FBQyxDQUFDO0lBQ2hGLENBQUM7SUFFUyxhQUFhLENBQUMsR0FBUSxFQUFFLEdBQVcsRUFBRSxTQUFrQixLQUFLLEVBQUUsU0FBa0IsS0FBSztRQUMzRixPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDO1lBQ2hDLEtBQUssQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUN2RSxLQUFLLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztJQUMzRCxDQUFDOztBQVZjLG1DQUFTLEdBQThCLElB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WUFFRCxhQUFhLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUN0QztRQUVELE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUNwQyxDQUFDOzs7WUFuR0osSUFBSSxTQUFDO2dCQUNGLElBQUksRUFBRSxrQkFBa0I7YUFDM0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQaXBlLCBQaXBlVHJhbnNmb3JtIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBHcmlkQ29sdW1uRGF0YVR5cGUgfSBmcm9tICcuLi8uLi9kYXRhLW9wZXJhdGlvbnMvZGF0YS11dGlsJztcbmltcG9ydCB7IElHcm91cGluZ0V4cHJlc3Npb24gfSBmcm9tICcuLi8uLi9kYXRhLW9wZXJhdGlvbnMvZ3JvdXBpbmctZXhwcmVzc2lvbi5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgSWd4U29ydGluZyB9IGZyb20gJy4uLy4uL2RhdGEtb3BlcmF0aW9ucy9zb3J0aW5nLXN0cmF0ZWd5JztcbmltcG9ydCB7IElneFRyZWVHcmlkQ29tcG9uZW50IH0gZnJvbSAnLi90cmVlLWdyaWQuY29tcG9uZW50JztcblxuY29uc3QgSElEREVOX0ZJRUxEX05BTUUgPSAnX0lneF9IaWRkZW5fRGF0YV8nO1xuXG4vKipcbiAqIEBoaWRkZW5cbiAqIEBpbnRlcm5hbFxuICovXG5jbGFzcyBHcm91cEJ5UmVjb3JkIHtcbiAgICBwdWJsaWMga2V5OiBzdHJpbmc7XG4gICAgcHVibGljIHZhbHVlOiBhbnk7XG4gICAgcHVibGljIGdyb3VwczogR3JvdXBCeVJlY29yZFtdO1xuICAgIHB1YmxpYyByZWNvcmRzOiBhbnlbXTtcbn1cblxuZXhwb3J0IGNsYXNzIElUcmVlR3JpZEFnZ3JlZ2F0aW9uIHtcbiAgICBwdWJsaWMgZmllbGQ6IHN0cmluZztcbiAgICBwdWJsaWMgYWdncmVnYXRlOiAocGFyZW50OiBhbnksIGNoaWxkcmVuOiBhbnlbXSkgPT4gYW55O1xufVxuXG5leHBvcnQgY2xhc3MgSWd4R3JvdXBlZFRyZWVHcmlkU29ydGluZyBleHRlbmRzIElneFNvcnRpbmcge1xuICAgIHByaXZhdGUgc3RhdGljIF9pbnN0YW5jZTogSWd4R3JvdXBlZFRyZWVHcmlkU29ydGluZyA9IG51bGw7XG5cbiAgICBwdWJsaWMgc3RhdGljIGluc3RhbmNlKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5faW5zdGFuY2UgfHwgKHRoaXMuX2luc3RhbmNlID0gbmV3IElneEdyb3VwZWRUcmVlR3JpZFNvcnRpbmcoKSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGdldEZpZWxkVmFsdWUob2JqOiBhbnksIGtleTogc3RyaW5nLCBpc0RhdGU6IGJvb2xlYW4gPSBmYWxzZSwgaXNUaW1lOiBib29sZWFuID0gZmFsc2UpOiBhbnkge1xuICAgICAgICByZXR1cm4gb2JqLmRhdGFbSElEREVOX0ZJRUxEX05BTUVdID9cbiAgICAgICAgICAgIHN1cGVyLmdldEZpZWxkVmFsdWUob2JqLmRhdGFbSElEREVOX0ZJRUxEX05BTUVdLCBrZXksIGlzRGF0ZSwgaXNUaW1lKSA6XG4gICAgICAgICAgICBzdXBlci5nZXRGaWVsZFZhbHVlKG9iai5kYXRhLCBrZXksIGlzRGF0ZSwgaXNUaW1lKTtcbiAgICB9XG59XG5cbi8qKiBAaGlkZGVuICovXG5AUGlwZSh7XG4gICAgbmFtZTogJ3RyZWVHcmlkR3JvdXBpbmcnXG59KVxuZXhwb3J0IGNsYXNzIElneFRyZWVHcmlkR3JvdXBpbmdQaXBlIGltcGxlbWVudHMgUGlwZVRyYW5zZm9ybSB7XG4gICAgcHJpdmF0ZSBncmlkOiBJZ3hUcmVlR3JpZENvbXBvbmVudDtcblxuICAgIHB1YmxpYyB0cmFuc2Zvcm0oY29sbGVjdGlvbjogYW55W10sXG4gICAgICAgICAgICAgICAgICAgICBncm91cGluZ0V4cHJlc3Npb25zOiBJR3JvdXBpbmdFeHByZXNzaW9uW10sXG4gICAgICAgICAgICAgICAgICAgICBncm91cEtleTogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgY2hpbGREYXRhS2V5OiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICBncmlkOiBJZ3hUcmVlR3JpZENvbXBvbmVudCxcbiAgICAgICAgICAgICAgICAgICAgIGFnZ3JlZ2F0aW9ucz86IElUcmVlR3JpZEFnZ3JlZ2F0aW9uW11cbiAgICAgICAgICAgICAgICAgICAgKTogYW55W10ge1xuICAgICAgICBpZiAoZ3JvdXBpbmdFeHByZXNzaW9ucy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiBjb2xsZWN0aW9uO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGdyb3VwS2V5Py50b0xvd2VyQ2FzZSgpID09PSBjaGlsZERhdGFLZXk/LnRvTG93ZXJDYXNlKCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignR3JvdXAga2V5IGFuZCBjaGlsZCBkYXRhIGtleSBjYW5ub3QgYmUgdGhlIHNhbWUuJyk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmdyaWQgPSBncmlkO1xuXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IFtdO1xuICAgICAgICBjb25zdCBncm91cGVkUmVjb3JkcyA9IHRoaXMuZ3JvdXBCeU11bHRpcGxlKGNvbGxlY3Rpb24sIGdyb3VwaW5nRXhwcmVzc2lvbnMpO1xuICAgICAgICB0aGlzLmZsYXR0ZW5Hcm91cGluZyhncm91cGVkUmVjb3JkcywgZ3JvdXBLZXksXG4gICAgICAgICAgICBjaGlsZERhdGFLZXksIHJlc3VsdCwgYWdncmVnYXRpb25zKTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIHByaXZhdGUgZmxhdHRlbkdyb3VwaW5nKGdyb3VwUmVjb3JkczogR3JvdXBCeVJlY29yZFtdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwS2V5OiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGREYXRhS2V5OiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogYW55W10sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWdncmVnYXRpb25zOiBJVHJlZUdyaWRBZ2dyZWdhdGlvbltdID0gW10pIHtcbiAgICAgICAgZm9yIChjb25zdCBncm91cFJlY29yZCBvZiBncm91cFJlY29yZHMpIHtcbiAgICAgICAgICAgIGNvbnN0IHBhcmVudCA9IHt9O1xuICAgICAgICAgICAgY29uc3QgY2hpbGRyZW4gPSBncm91cFJlY29yZC5yZWNvcmRzO1xuXG4gICAgICAgICAgICBwYXJlbnRbY2hpbGREYXRhS2V5XSA9IFtdO1xuXG4gICAgICAgICAgICBmb3IgKGNvbnN0IGFnZ3JlZ2F0aW9uIG9mIGFnZ3JlZ2F0aW9ucykge1xuICAgICAgICAgICAgICAgIHBhcmVudFthZ2dyZWdhdGlvbi5maWVsZF0gPSBhZ2dyZWdhdGlvbi5hZ2dyZWdhdGUocGFyZW50LCBjaGlsZHJlbik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHBhcmVudFtncm91cEtleV0gPSBncm91cFJlY29yZC52YWx1ZSArIGAgKCR7Z3JvdXBSZWNvcmQucmVjb3Jkcy5sZW5ndGh9KWA7XG4gICAgICAgICAgICBwYXJlbnRbSElEREVOX0ZJRUxEX05BTUVdID0geyBbZ3JvdXBSZWNvcmQua2V5XTogZ3JvdXBSZWNvcmQudmFsdWUgfTtcbiAgICAgICAgICAgIGRhdGEucHVzaChwYXJlbnQpO1xuXG4gICAgICAgICAgICBpZiAoZ3JvdXBSZWNvcmQuZ3JvdXBzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5mbGF0dGVuR3JvdXBpbmcoZ3JvdXBSZWNvcmQuZ3JvdXBzLCBncm91cEtleSwgY2hpbGREYXRhS2V5LFxuICAgICAgICAgICAgICAgICAgICBwYXJlbnRbY2hpbGREYXRhS2V5XSwgYWdncmVnYXRpb25zKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcGFyZW50W2NoaWxkRGF0YUtleV0gPSBjaGlsZHJlbjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZ3JvdXBCeU11bHRpcGxlKGFycmF5OiBhbnlbXSwgZ3JvdXBpbmdFeHByZXNzaW9uczogSUdyb3VwaW5nRXhwcmVzc2lvbltdLCBpbmRleCA9IDApOiBHcm91cEJ5UmVjb3JkW10ge1xuICAgICAgICBjb25zdCByZXMgPSB0aGlzLmdyb3VwQnkoYXJyYXksIGdyb3VwaW5nRXhwcmVzc2lvbnNbaW5kZXhdKTtcblxuICAgICAgICBpZiAoaW5kZXggKyAxIDwgZ3JvdXBpbmdFeHByZXNzaW9ucy5sZW5ndGgpIHtcbiAgICAgICAgICAgZm9yIChjb25zdCBncm91cEJ5UmVjb3JkIG9mIHJlcykge1xuICAgICAgICAgICAgICAgIGdyb3VwQnlSZWNvcmQuZ3JvdXBzID0gdGhpcy5ncm91cEJ5TXVsdGlwbGUoZ3JvdXBCeVJlY29yZC5yZWNvcmRzLCBncm91cGluZ0V4cHJlc3Npb25zLCBpbmRleCArIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlcztcbiAgICB9XG5cbiAgICBwcml2YXRlIGdyb3VwQnkoYXJyYXk6IGFueVtdLCBncm91cGluZ0V4cHJlc3Npb246IElHcm91cGluZ0V4cHJlc3Npb24pOiBHcm91cEJ5UmVjb3JkW10ge1xuICAgICAgICBjb25zdCBrZXkgPSBncm91cGluZ0V4cHJlc3Npb24uZmllbGROYW1lO1xuICAgICAgICBjb25zdCBjb2x1bW4gPSB0aGlzLmdyaWQ/LmdldENvbHVtbkJ5TmFtZShrZXkpO1xuICAgICAgICBjb25zdCBpc0RhdGVUaW1lID0gY29sdW1uPy5kYXRhVHlwZSA9PT0gR3JpZENvbHVtbkRhdGFUeXBlLkRhdGUgfHxcbiAgICAgICAgICAgIGNvbHVtbj8uZGF0YVR5cGUgPT09IEdyaWRDb2x1bW5EYXRhVHlwZS5EYXRlVGltZSB8fFxuICAgICAgICAgICAgY29sdW1uPy5kYXRhVHlwZSA9PT0gR3JpZENvbHVtbkRhdGFUeXBlLlRpbWU7XG4gICAgICAgIGNvbnN0IG1hcDogTWFwPGFueSwgR3JvdXBCeVJlY29yZD4gPSBuZXcgTWFwPGFueSwgR3JvdXBCeVJlY29yZD4oKTtcbiAgICAgICAgZm9yIChjb25zdCByZWNvcmQgb2YgYXJyYXkpIHtcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gaXNEYXRlVGltZVxuICAgICAgICAgICAgICAgID8gdGhpcy5ncmlkLmRhdGVQaXBlLnRyYW5zZm9ybShyZWNvcmRba2V5XSlcbiAgICAgICAgICAgICAgICA6IHJlY29yZFtrZXldO1xuXG4gICAgICAgICAgICBsZXQgZ3JvdXBCeVJlY29yZDogR3JvdXBCeVJlY29yZDtcblxuICAgICAgICAgICAgaWYgKG1hcC5oYXModmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgZ3JvdXBCeVJlY29yZCA9IG1hcC5nZXQodmFsdWUpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBncm91cEJ5UmVjb3JkID0gbmV3IEdyb3VwQnlSZWNvcmQoKTtcbiAgICAgICAgICAgICAgICBncm91cEJ5UmVjb3JkLmtleSA9IGtleTtcbiAgICAgICAgICAgICAgICBncm91cEJ5UmVjb3JkLnZhbHVlID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgZ3JvdXBCeVJlY29yZC5yZWNvcmRzID0gW107XG4gICAgICAgICAgICAgICAgbWFwLnNldCh2YWx1ZSwgZ3JvdXBCeVJlY29yZCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGdyb3VwQnlSZWNvcmQucmVjb3Jkcy5wdXNoKHJlY29yZCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gQXJyYXkuZnJvbShtYXAudmFsdWVzKCkpO1xuICAgIH1cbn1cbiJdfQ==
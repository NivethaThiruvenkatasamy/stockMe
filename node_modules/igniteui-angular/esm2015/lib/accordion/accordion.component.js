import { ChangeDetectorRef, Component, ContentChildren, EventEmitter, HostBinding, Input, Output } from '@angular/core';
import { fromEvent, Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { ACCORDION_NAVIGATION_KEYS } from '../core/utils';
import { IgxExpansionPanelComponent } from '../expansion-panel/expansion-panel.component';
let NEXT_ID = 0;
/**
 * IgxAccordion is a container-based component that contains that can house multiple expansion panels.
 *
 * @igxModule IgxAccordionModule
 *
 * @igxKeywords accordion
 *
 * @igxGroup Layouts
 *
 * @remark
 * The Ignite UI for Angular Accordion component enables the user to navigate among multiple collapsing panels
 * displayed in a single container.
 * The accordion offers keyboard navigation and API to control the underlying panels' expansion state.
 *
 * @example
 * ```html
 * <igx-accordion>
 *   <igx-expansion-panel *ngFor="let panel of panels">
 *       ...
 *   </igx-expansion-panel>
 * </igx-accordion>
 * ```
 */
export class IgxAccordionComponent {
    constructor(cdr) {
        this.cdr = cdr;
        /**
         * Get/Set the `id` of the accordion component.
         * Default value is `"igx-accordion-0"`;
         * ```html
         * <igx-accordion id="my-first-accordion"></igx-accordion>
         * ```
         * ```typescript
         * const accordionId = this.accordion.id;
         * ```
         */
        this.id = `igx-accordion-${NEXT_ID++}`;
        /** @hidden @internal **/
        this.cssClass = 'igx-accordion';
        /** @hidden @internal **/
        this.displayStyle = 'block';
        /**
         * Emitted before a panel is expanded.
         *
         * @remarks
         * This event is cancelable.
         *
         * ```html
         * <igx-accordion (panelExpanding)="handlePanelExpanding($event)">
         * </igx-accordion>
         * ```
         *
         *```typescript
         * public handlePanelExpanding(event: IExpansionPanelCancelableEventArgs){
         *  const expandedPanel: IgxExpansionPanelComponent = event.panel;
         *  if (expandedPanel.disabled) {
         *      event.cancel = true;
         *  }
         * }
         *```
         */
        this.panelExpanding = new EventEmitter();
        /**
         * Emitted after a panel has been expanded.
         *
         * ```html
         * <igx-accordion (panelExpanded)="handlePanelExpanded($event)">
         * </igx-accordion>
         * ```
         *
         *```typescript
         * public handlePanelExpanded(event: IExpansionPanelCancelableEventArgs) {
         *  const expandedPanel: IgxExpansionPanelComponent = event.panel;
         *  console.log("Panel is expanded: ", expandedPanel.id);
         * }
         *```
         */
        this.panelExpanded = new EventEmitter();
        /**
         * Emitted before a panel is collapsed.
         *
         * @remarks
         * This event is cancelable.
         *
         * ```html
         * <igx-accordion (panelCollapsing)="handlePanelCollapsing($event)">
         * </igx-accordion>
         * ```
         */
        this.panelCollapsing = new EventEmitter();
        /**
         * Emitted after a panel has been collapsed.
         *
         * ```html
         * <igx-accordion (panelCollapsed)="handlePanelCollapsed($event)">
         * </igx-accordion>
         * ```
         */
        this.panelCollapsed = new EventEmitter();
        this._destroy$ = new Subject();
        this._unsubChildren$ = new Subject();
        this._singleBranchExpand = false;
    }
    /**
     * Get/Set the animation settings that panels should use when expanding/collpasing.
     *
     * ```html
     * <igx-accordion [animationSettings]="customAnimationSettings"></igx-accordion>
     * ```
     *
     * ```typescript
     * const customAnimationSettings: ToggleAnimationSettings = {
     *      openAnimation: growVerIn,
     *      closeAnimation: growVerOut
     * };
     *
     * this.accordion.animationSettings = customAnimationSettings;
     * ```
     */
    get animationSettings() {
        return this._animationSettings;
    }
    set animationSettings(value) {
        this._animationSettings = value;
        this.updatePanelsAnimation();
    }
    /**
     * Get/Set how the accordion handles the expansion of the projected expansion panels.
     * If set to `true`, only a single panel can be expanded at a time, collapsing all others
     *
     * ```html
     * <igx-accordion [singleBranchExpand]="true">
     * ...
     * </igx-accordion>
     * ```
     *
     * ```typescript
     * this.accordion.singleBranchExpand = false;
     * ```
     */
    get singleBranchExpand() {
        return this._singleBranchExpand;
    }
    set singleBranchExpand(val) {
        this._singleBranchExpand = val;
        if (val) {
            this.collapseAllExceptLast();
        }
    }
    /**
     * Get all panels.
     *
     * ```typescript
     * const panels: IgxExpansionPanelComponent[] = this.accordion.panels;
     * ```
     */
    get panels() {
        var _a;
        return (_a = this._panels) === null || _a === void 0 ? void 0 : _a.toArray();
    }
    /** @hidden @internal **/
    ngAfterContentInit() {
        this.updatePanelsAnimation();
        if (this.singleBranchExpand) {
            this.collapseAllExceptLast();
        }
    }
    /** @hidden @internal **/
    ngAfterViewInit() {
        this._expandedPanels = new Set(this._panels.filter(panel => !panel.collapsed));
        this._expandingPanels = new Set();
        this._panels.changes.pipe(takeUntil(this._destroy$)).subscribe(() => {
            this.subToChanges();
        });
        this.subToChanges();
    }
    /** @hidden @internal */
    ngOnDestroy() {
        this._unsubChildren$.next();
        this._unsubChildren$.complete();
        this._destroy$.next();
        this._destroy$.complete();
    }
    /**
     * Expands all collapsed expansion panels.
     *
     * ```typescript
     * accordion.expandAll();
     * ```
     */
    expandAll() {
        if (this.singleBranchExpand) {
            for (let i = 0; i < this.panels.length - 1; i++) {
                this.panels[i].collapse();
            }
            this._panels.last.expand();
            return;
        }
        this.panels.forEach(panel => panel.expand());
    }
    /**
     * Collapses all expanded expansion panels.
     *
     * ```typescript
     * accordion.collapseAll();
     * ```
     */
    collapseAll() {
        this.panels.forEach(panel => panel.collapse());
    }
    collapseAllExceptLast() {
        var _a, _b;
        const lastExpanded = (_a = this.panels) === null || _a === void 0 ? void 0 : _a.filter(p => !p.collapsed && !p.header.disabled).pop();
        (_b = this.panels) === null || _b === void 0 ? void 0 : _b.forEach((p) => {
            if (p !== lastExpanded && !p.header.disabled) {
                p.collapsed = true;
            }
        });
        this.cdr.detectChanges();
    }
    handleKeydown(event, panel) {
        const key = event.key.toLowerCase();
        if (!(ACCORDION_NAVIGATION_KEYS.has(key))) {
            return;
        }
        // TO DO: if we ever want to improve the performance of the accordion,
        // enabledPanels could be cached (by making a disabledChange emitter on the panel header)
        this._enabledPanels = this._panels.filter(p => !p.header.disabled);
        event.preventDefault();
        this.handleNavigation(event, panel);
    }
    handleNavigation(event, panel) {
        switch (event.key.toLowerCase()) {
            case 'home':
                this._enabledPanels[0].header.innerElement.focus();
                break;
            case 'end':
                this._enabledPanels[this._enabledPanels.length - 1].header.innerElement.focus();
                break;
            case 'arrowup':
            case 'up':
                this.handleUpDownArrow(true, event, panel);
                break;
            case 'arrowdown':
            case 'down':
                this.handleUpDownArrow(false, event, panel);
                break;
        }
    }
    handleUpDownArrow(isUp, event, panel) {
        if (!event.altKey) {
            const focusedPanel = panel;
            const next = this.getNextPanel(focusedPanel, isUp ? -1 : 1);
            if (next === focusedPanel) {
                return;
            }
            next.header.innerElement.focus();
        }
        if (event.altKey && event.shiftKey) {
            if (isUp) {
                this._enabledPanels.forEach(p => p.collapse());
            }
            else {
                if (this.singleBranchExpand) {
                    for (let i = 0; i < this._enabledPanels.length - 1; i++) {
                        this._enabledPanels[i].collapse();
                    }
                    this._enabledPanels[this._enabledPanels.length - 1].expand();
                    return;
                }
                this._enabledPanels.forEach(p => p.expand());
            }
        }
    }
    getNextPanel(panel, dir = 1) {
        const panelIndex = this._enabledPanels.indexOf(panel);
        return this._enabledPanels[panelIndex + dir] || panel;
    }
    subToChanges() {
        this._unsubChildren$.next();
        this._panels.forEach(panel => {
            panel.contentExpanded.pipe(takeUntil(this._unsubChildren$)).subscribe((args) => {
                this._expandedPanels.add(args.owner);
                this._expandingPanels.delete(args.owner);
                const evArgs = Object.assign(Object.assign({}, args), { owner: this, panel: args.owner });
                this.panelExpanded.emit(evArgs);
            });
            panel.contentExpanding.pipe(takeUntil(this._unsubChildren$)).subscribe((args) => {
                if (args.cancel) {
                    return;
                }
                const evArgs = Object.assign(Object.assign({}, args), { owner: this, panel: args.owner });
                this.panelExpanding.emit(evArgs);
                if (evArgs.cancel) {
                    args.cancel = true;
                    return;
                }
                if (this.singleBranchExpand) {
                    this._expandedPanels.forEach(p => {
                        if (!p.header.disabled) {
                            p.collapse();
                        }
                    });
                    this._expandingPanels.forEach(p => {
                        var _a, _b;
                        if (!p.header.disabled) {
                            if (!p.animationSettings.closeAnimation) {
                                (_a = p.openAnimationPlayer) === null || _a === void 0 ? void 0 : _a.reset();
                            }
                            if (!p.animationSettings.openAnimation) {
                                (_b = p.closeAnimationPlayer) === null || _b === void 0 ? void 0 : _b.reset();
                            }
                            p.collapse();
                        }
                    });
                    this._expandingPanels.add(args.owner);
                }
            });
            panel.contentCollapsed.pipe(takeUntil(this._unsubChildren$)).subscribe((args) => {
                this._expandedPanels.delete(args.owner);
                this._expandingPanels.delete(args.owner);
                const evArgs = Object.assign(Object.assign({}, args), { owner: this, panel: args.owner });
                this.panelCollapsed.emit(evArgs);
            });
            panel.contentCollapsing.pipe(takeUntil(this._unsubChildren$)).subscribe((args) => {
                const evArgs = Object.assign(Object.assign({}, args), { owner: this, panel: args.owner });
                this.panelCollapsing.emit(evArgs);
                if (evArgs.cancel) {
                    args.cancel = true;
                }
            });
            fromEvent(panel.header.innerElement, 'keydown')
                .pipe(takeUntil(this._unsubChildren$))
                .subscribe((e) => {
                this.handleKeydown(e, panel);
            });
        });
    }
    updatePanelsAnimation() {
        var _a;
        if (this.animationSettings !== undefined) {
            (_a = this.panels) === null || _a === void 0 ? void 0 : _a.forEach(panel => panel.animationSettings = this.animationSettings);
        }
    }
}
IgxAccordionComponent.decorators = [
    { type: Component, args: [{
                selector: 'igx-accordion',
                template: "<ng-content select=\"igx-expansion-panel\"></ng-content>\n"
            },] }
];
IgxAccordionComponent.ctorParameters = () => [
    { type: ChangeDetectorRef }
];
IgxAccordionComponent.propDecorators = {
    id: [{ type: HostBinding, args: ['attr.id',] }, { type: Input }],
    cssClass: [{ type: HostBinding, args: ['class.igx-accordion',] }],
    displayStyle: [{ type: HostBinding, args: ['style.display',] }],
    animationSettings: [{ type: Input }],
    singleBranchExpand: [{ type: Input }],
    panelExpanding: [{ type: Output }],
    panelExpanded: [{ type: Output }],
    panelCollapsing: [{ type: Output }],
    panelCollapsed: [{ type: Output }],
    _panels: [{ type: ContentChildren, args: [IgxExpansionPanelComponent,] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWNjb3JkaW9uLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2lnbml0ZXVpLWFuZ3VsYXIvc3JjL2xpYi9hY2NvcmRpb24vYWNjb3JkaW9uLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQW1DLGlCQUFpQixFQUFFLFNBQVMsRUFBRSxlQUFlLEVBQUUsWUFBWSxFQUNqRyxXQUFXLEVBQUUsS0FBSyxFQUFhLE1BQU0sRUFBYSxNQUFNLGVBQWUsQ0FBQztBQUM1RSxPQUFPLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMxQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRzFELE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLDhDQUE4QyxDQUFDO0FBZTFGLElBQUksT0FBTyxHQUFHLENBQUMsQ0FBQztBQUVoQjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQXNCRztBQUtILE1BQU0sT0FBTyxxQkFBcUI7SUFrSzlCLFlBQW9CLEdBQXNCO1FBQXRCLFFBQUcsR0FBSCxHQUFHLENBQW1CO1FBaksxQzs7Ozs7Ozs7O1dBU0c7UUFHSSxPQUFFLEdBQUcsaUJBQWlCLE9BQU8sRUFBRSxFQUFFLENBQUM7UUFFekMseUJBQXlCO1FBRWxCLGFBQVEsR0FBRyxlQUFlLENBQUM7UUFFbEMseUJBQXlCO1FBRWxCLGlCQUFZLEdBQUcsT0FBTyxDQUFDO1FBc0Q5Qjs7Ozs7Ozs7Ozs7Ozs7Ozs7OztXQW1CRztRQUVJLG1CQUFjLEdBQUcsSUFBSSxZQUFZLEVBQWlDLENBQUM7UUFFMUU7Ozs7Ozs7Ozs7Ozs7O1dBY0c7UUFFSSxrQkFBYSxHQUFHLElBQUksWUFBWSxFQUF1QixDQUFDO1FBRS9EOzs7Ozs7Ozs7O1dBVUc7UUFFSSxvQkFBZSxH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dUJBSUwsV0FBVyxTQUFDLHFCQUFxQjsyQkFJakMsV0FBVyxTQUFDLGVBQWU7Z0NBbUIzQixLQUFLO2lDQXdCTCxLQUFLOzZCQWdDTCxNQUFNOzRCQWtCTixNQUFNOzhCQWNOLE1BQU07NkJBV04sTUFBTTtzQkFjTixlQUFlLFNBQUMsMEJBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWZ0ZXJDb250ZW50SW5pdCwgQWZ0ZXJWaWV3SW5pdCwgQ2hhbmdlRGV0ZWN0b3JSZWYsIENvbXBvbmVudCwgQ29udGVudENoaWxkcmVuLCBFdmVudEVtaXR0ZXIsXG4gICAgSG9zdEJpbmRpbmcsIElucHV0LCBPbkRlc3Ryb3ksIE91dHB1dCwgUXVlcnlMaXN0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBmcm9tRXZlbnQsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRha2VVbnRpbCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEFDQ09SRElPTl9OQVZJR0FUSU9OX0tFWVMgfSBmcm9tICcuLi9jb3JlL3V0aWxzJztcbmltcG9ydCB7IElFeHBhbnNpb25QYW5lbENhbmNlbGFibGVFdmVudEFyZ3MsXG4gICAgSUV4cGFuc2lvblBhbmVsRXZlbnRBcmdzLCBJZ3hFeHBhbnNpb25QYW5lbEJhc2UgfSBmcm9tICcuLi9leHBhbnNpb24tcGFuZWwvZXhwYW5zaW9uLXBhbmVsLmNvbW1vbic7XG5pbXBvcnQgeyBJZ3hFeHBhbnNpb25QYW5lbENvbXBvbmVudCB9IGZyb20gJy4uL2V4cGFuc2lvbi1wYW5lbC9leHBhbnNpb24tcGFuZWwuY29tcG9uZW50JztcbmltcG9ydCB7IFRvZ2dsZUFuaW1hdGlvblNldHRpbmdzIH0gZnJvbSAnLi4vZXhwYW5zaW9uLXBhbmVsL3RvZ2dsZS1hbmltYXRpb24tY29tcG9uZW50JztcblxuZXhwb3J0IGludGVyZmFjZSBJQWNjb3JkaW9uRXZlbnRBcmdzIGV4dGVuZHMgSUV4cGFuc2lvblBhbmVsRXZlbnRBcmdzIHtcbiAgICBvd25lcjogSWd4QWNjb3JkaW9uQ29tcG9uZW50O1xuICAgIC8qKiBQcm92aWRlcyBhIHJlZmVyZW5jZSB0byB0aGUgYElneEV4cGFuc2lvblBhbmVsQ29tcG9uZW50YCB3aGljaCB3YXMgZXhwYW5kZWQvY29sbGFwc2VkLiAqL1xuICAgIHBhbmVsOiBJZ3hFeHBhbnNpb25QYW5lbEJhc2U7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUFjY29yZGlvbkNhbmNlbGFibGVFdmVudEFyZ3MgZXh0ZW5kcyBJRXhwYW5zaW9uUGFuZWxDYW5jZWxhYmxlRXZlbnRBcmdzIHtcbiAgICBvd25lcjogSWd4QWNjb3JkaW9uQ29tcG9uZW50O1xuICAgIC8qKiBQcm92aWRlcyBhIHJlZmVyZW5jZSB0byB0aGUgYElneEV4cGFuc2lvblBhbmVsQ29tcG9uZW50YCB3aGljaCBpcyBjdXJyZW50bHkgZXhwYW5kaW5nL2NvbGxhcHNpbmcuICovXG4gICAgcGFuZWw6IElneEV4cGFuc2lvblBhbmVsQmFzZTtcbn1cblxubGV0IE5FWFRfSUQgPSAwO1xuXG4vKipcbiAqIElneEFjY29yZGlvbiBpcyBhIGNvbnRhaW5lci1iYXNlZCBjb21wb25lbnQgdGhhdCBjb250YWlucyB0aGF0IGNhbiBob3VzZSBtdWx0aXBsZSBleHBhbnNpb24gcGFuZWxzLlxuICpcbiAqIEBpZ3hNb2R1bGUgSWd4QWNjb3JkaW9uTW9kdWxlXG4gKlxuICogQGlneEtleXdvcmRzIGFjY29yZGlvblxuICpcbiAqIEBpZ3hHcm91cCBMYXlvdXRzXG4gKlxuICogQHJlbWFya1xuICogVGhlIElnbml0ZSBVSSBmb3IgQW5ndWxhciBBY2NvcmRpb24gY29tcG9uZW50IGVuYWJsZXMgdGhlIHVzZXIgdG8gbmF2aWdhdGUgYW1vbmcgbXVsdGlwbGUgY29sbGFwc2luZyBwYW5lbHNcbiAqIGRpc3BsYXllZCBpbiBhIHNpbmdsZSBjb250YWluZXIuXG4gKiBUaGUgYWNjb3JkaW9uIG9mZmVycyBrZXlib2FyZCBuYXZpZ2F0aW9uIGFuZCBBUEkgdG8gY29udHJvbCB0aGUgdW5kZXJseWluZyBwYW5lbHMnIGV4cGFuc2lvbiBzdGF0ZS5cbiAqXG4gKiBAZXhhbXBsZVxuICogYGBgaHRtbFxuICogPGlneC1hY2NvcmRpb24+XG4gKiAgIDxpZ3gtZXhwYW5zaW9uLXBhbmVsICpuZ0Zvcj1cImxldCBwYW5lbCBvZiBwYW5lbHNcIj5cbiAqICAgICAgIC4uLlxuICogICA8L2lneC1leHBhbnNpb24tcGFuZWw+XG4gKiA8L2lneC1hY2NvcmRpb24+XG4gKiBgYGBcbiAqL1xuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdpZ3gtYWNjb3JkaW9uJyxcbiAgICB0ZW1wbGF0ZVVybDogJ2FjY29yZGlvbi5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgSWd4QWNjb3JkaW9uQ29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJDb250ZW50SW5pdCwgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95IHtcbiAgICAvKipcbiAgICAgKiBHZXQvU2V0IHRoZSBgaWRgIG9mIHRoZSBhY2NvcmRpb24gY29tcG9uZW50LlxuICAgICAqIERlZmF1bHQgdmFsdWUgaXMgYFwiaWd4LWFjY29yZGlvbi0wXCJgO1xuICAgICAqIGBgYGh0bWxcbiAgICAgKiA8aWd4LWFjY29yZGlvbiBpZD1cIm15LWZpcnN0LWFjY29yZGlvblwiPjwvaWd4LWFjY29yZGlvbj5cbiAgICAgKiBgYGBcbiAgICAgKiBgYGB0eXBlc2NyaXB0XG4gICAgICogY29uc3QgYWNjb3JkaW9uSWQgPSB0aGlzLmFjY29yZGlvbi5pZDtcbiAgICAgKiBgYGBcbiAgICAgKi9cbiAgICBASG9zdEJpbmRpbmcoJ2F0dHIuaWQnKVxuICAgIEBJbnB1dCgpXG4gICAgcHVibGljIGlkID0gYGlneC1hY2NvcmRpb24tJHtORVhUX0lEKyt9YDtcblxuICAgIC8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqKi9cbiAgICBASG9zdEJpbmRpbmcoJ2NsYXNzLmlneC1hY2NvcmRpb24nKVxuICAgIHB1YmxpYyBjc3NDbGFzcyA9ICdpZ3gtYWNjb3JkaW9uJztcblxuICAgIC8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqKi9cbiAgICBASG9zdEJpbmRpbmcoJ3N0eWxlLmRpc3BsYXknKVxuICAgIHB1YmxpYyBkaXNwbGF5U3R5bGUgPSAnYmxvY2snO1xuXG4gICAgLyoqXG4gICAgICogR2V0L1NldCB0aGUgYW5pbWF0aW9uIHNldHRpbmdzIHRoYXQgcGFuZWxzIHNob3VsZCB1c2Ugd2hlbiBleHBhbmRpbmcvY29sbHBhc2luZy5cbiAgICAgKlxuICAgICAqIGBgYGh0bWxcbiAgICAgKiA8aWd4LWFjY29yZGlvbiBbYW5pbWF0aW9uU2V0dGluZ3NdPVwiY3VzdG9tQW5pbWF0aW9uU2V0dGluZ3NcIj48L2lneC1hY2NvcmRpb24+XG4gICAgICogYGBgXG4gICAgICpcbiAgICAgKiBgYGB0eXBlc2NyaXB0XG4gICAgICogY29uc3QgY3VzdG9tQW5pbWF0aW9uU2V0dGluZ3M6IFRvZ2dsZUFuaW1hdGlvblNldHRpbmdzID0ge1xuICAgICAqICAgICAgb3BlbkFuaW1hdGlvbjogZ3Jvd1ZlckluLFxuICAgICAqICAgICAgY2xvc2VBbmltYXRpb246IGdyb3dWZXJPdXRcbiAgICAgKiB9O1xuICAgICAqXG4gICAgICogdGhpcy5hY2NvcmRpb24uYW5pbWF0aW9uU2V0dGluZ3MgPSBjdXN0b21BbmltYXRpb25TZXR0aW5ncztcbiAgICAgKiBgYGBcbiAgICAgKi9cbiAgICBASW5wdXQoKVxuICAgIHB1YmxpYyBnZXQgYW5pbWF0aW9uU2V0dGluZ3MoKTogVG9nZ2xlQW5pbWF0aW9uU2V0dGluZ3Mge1xuICAgICAgICByZXR1cm4gdGhpcy5fYW5pbWF0aW9uU2V0dGluZ3M7XG4gICAgfVxuXG4gICAgcHVibGljIHNldCBhbmltYXRpb25TZXR0aW5ncyh2YWx1ZTogVG9nZ2xlQW5pbWF0aW9uU2V0dGluZ3MpIHtcbiAgICAgICAgdGhpcy5fYW5pbWF0aW9uU2V0dGluZ3MgPSB2YWx1ZTtcbiAgICAgICAgdGhpcy51cGRhdGVQYW5lbHNBbmltYXRpb24oKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQvU2V0IGhvdyB0aGUgYWNjb3JkaW9uIGhhbmRsZXMgdGhlIGV4cGFuc2lvbiBvZiB0aGUgcHJvamVjdGVkIGV4cGFuc2lvbiBwYW5lbHMuXG4gICAgICogSWYgc2V0IHRvIGB0cnVlYCwgb25seSBhIHNpbmdsZSBwYW5lbCBjYW4gYmUgZXhwYW5kZWQgYXQgYSB0aW1lLCBjb2xsYXBzaW5nIGFsbCBvdGhlcnNcbiAgICAgKlxuICAgICAqIGBgYGh0bWxcbiAgICAgKiA8aWd4LWFjY29yZGlvbiBbc2luZ2xlQnJhbmNoRXhwYW5kXT1cInRydWVcIj5cbiAgICAgKiAuLi5cbiAgICAgKiA8L2lneC1hY2NvcmRpb24+XG4gICAgICogYGBgXG4gICAgICpcbiAgICAgKiBgYGB0eXBlc2NyaXB0XG4gICAgICogdGhpcy5hY2NvcmRpb24uc2luZ2xlQnJhbmNoRXhwYW5kID0gZmFsc2U7XG4gICAgICogYGBgXG4gICAgICovXG4gICAgQElucHV0KClcbiAgICBwdWJsaWMgZ2V0IHNpbmdsZUJyYW5jaEV4cGFuZCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3NpbmdsZUJyYW5jaEV4cGFuZDtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0IHNpbmdsZUJyYW5jaEV4cGFuZCh2YWw6IGJvb2xlYW4pIHtcbiAgICAgICAgdGhpcy5fc2luZ2xlQnJhbmNoRXhwYW5kID0gdmFsO1xuICAgICAgICBpZiAodmFsKSB7XG4gICAgICAgICAgICB0aGlzLmNvbGxhcHNlQWxsRXhjZXB0TGFzdCgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRW1pdHRlZCBiZWZvcmUgYSBwYW5lbCBpcyBleHBhbmRlZC5cbiAgICAgKlxuICAgICAqIEByZW1hcmtzXG4gICAgICogVGhpcyBldmVudCBpcyBjYW5jZWxhYmxlLlxuICAgICAqXG4gICAgICogYGBgaHRtbFxuICAgICAqIDxpZ3gtYWNjb3JkaW9uIChwYW5lbEV4cGFuZGluZyk9XCJoYW5kbGVQYW5lbEV4cGFuZGluZygkZXZlbnQpXCI+XG4gICAgICogPC9pZ3gtYWNjb3JkaW9uPlxuICAgICAqIGBgYFxuICAgICAqXG4gICAgICpgYGB0eXBlc2NyaXB0XG4gICAgICogcHVibGljIGhhbmRsZVBhbmVsRXhwYW5kaW5nKGV2ZW50OiBJRXhwYW5zaW9uUGFuZWxDYW5jZWxhYmxlRXZlbnRBcmdzKXtcbiAgICAgKiAgY29uc3QgZXhwYW5kZWRQYW5lbDogSWd4RXhwYW5zaW9uUGFuZWxDb21wb25lbnQgPSBldmVudC5wYW5lbDtcbiAgICAgKiAgaWYgKGV4cGFuZGVkUGFuZWwuZGlzYWJsZWQpIHtcbiAgICAgKiAgICAgIGV2ZW50LmNhbmNlbCA9IHRydWU7XG4gICAgICogIH1cbiAgICAgKiB9XG4gICAgICpgYGBcbiAgICAgKi9cbiAgICBAT3V0cHV0KClcbiAgICBwdWJsaWMgcGFuZWxFeHBhbmRpbmcgPSBuZXcgRXZlbnRFbWl0dGVyPElBY2NvcmRpb25DYW5jZWxhYmxlRXZlbnRBcmdzPigpO1xuXG4gICAgLyoqXG4gICAgICogRW1pdHRlZCBhZnRlciBhIHBhbmVsIGhhcyBiZWVuIGV4cGFuZGVkLlxuICAgICAqXG4gICAgICogYGBgaHRtbFxuICAgICAqIDxpZ3gtYWNjb3JkaW9uIChwYW5lbEV4cGFuZGVkKT1cImhhbmRsZVBhbmVsRXhwYW5kZWQoJGV2ZW50KVwiPlxuICAgICAqIDwvaWd4LWFjY29yZGlvbj5cbiAgICAgKiBgYGBcbiAgICAgKlxuICAgICAqYGBgdHlwZXNjcmlwdFxuICAgICAqIHB1YmxpYyBoYW5kbGVQYW5lbEV4cGFuZGVkKGV2ZW50OiBJRXhwYW5zaW9uUGFuZWxDYW5jZWxhYmxlRXZlbnRBcmdzKSB7XG4gICAgICogIGNvbnN0IGV4cGFuZGVkUGFuZWw6IElneEV4cGFuc2lvblBhbmVsQ29tcG9uZW50ID0gZXZlbnQucGFuZWw7XG4gICAgICogIGNvbnNvbGUubG9nKFwiUGFuZWwgaXMgZXhwYW5kZWQ6IFwiLCBleHBhbmRlZFBhbmVsLmlkKTtcbiAgICAgKiB9XG4gICAgICpgYGBcbiAgICAgKi9cbiAgICBAT3V0cHV0KClcbiAgICBwdWJsaWMgcGFuZWxFeHBhbmRlZCA9IG5ldyBFdmVudEVtaXR0ZXI8SUFjY29yZGlvbkV2ZW50QXJncz4oKTtcblxuICAgIC8qKlxuICAgICAqIEVtaXR0ZWQgYmVmb3JlIGEgcGFuZWwgaXMgY29sbGFwc2VkLlxuICAgICAqXG4gICAgICogQHJlbWFya3NcbiAgICAgKiBUaGlzIGV2ZW50IGlzIGNhbmNlbGFibGUuXG4gICAgICpcbiAgICAgKiBgYGBodG1sXG4gICAgICogPGlneC1hY2NvcmRpb24gKHBhbmVsQ29sbGFwc2luZyk9XCJoYW5kbGVQYW5lbENvbGxhcHNpbmcoJGV2ZW50KVwiPlxuICAgICAqIDwvaWd4LWFjY29yZGlvbj5cbiAgICAgKiBgYGBcbiAgICAgKi9cbiAgICBAT3V0cHV0KClcbiAgICBwdWJsaWMgcGFuZWxDb2xsYXBzaW5nID0gbmV3IEV2ZW50RW1pdHRlcjxJQWNjb3JkaW9uQ2FuY2VsYWJsZUV2ZW50QXJncz4oKTtcblxuICAgIC8qKlxuICAgICAqIEVtaXR0ZWQgYWZ0ZXIgYSBwYW5lbCBoYXMgYmVlbiBjb2xsYXBzZWQuXG4gICAgICpcbiAgICAgKiBgYGBodG1sXG4gICAgICogPGlneC1hY2NvcmRpb24gKHBhbmVsQ29sbGFwc2VkKT1cImhhbmRsZVBhbmVsQ29sbGFwc2VkKCRldmVudClcIj5cbiAgICAgKiA8L2lneC1hY2NvcmRpb24+XG4gICAgICogYGBgXG4gICAgICovXG4gICAgQE91dHB1dCgpXG4gICAgcHVibGljIHBhbmVsQ29sbGFwc2VkID0gbmV3IEV2ZW50RW1pdHRlcjxJQWNjb3JkaW9uRXZlbnRBcmdzPigpO1xuXG4gICAgLyoqXG4gICAgICogR2V0IGFsbCBwYW5lbHMuXG4gICAgICpcbiAgICAgKiBgYGB0eXBlc2NyaXB0XG4gICAgICogY29uc3QgcGFuZWxzOiBJZ3hFeHBhbnNpb25QYW5lbENvbXBvbmVudFtdID0gdGhpcy5hY2NvcmRpb24ucGFuZWxzO1xuICAgICAqIGBgYFxuICAgICAqL1xuICAgIHB1YmxpYyBnZXQgcGFuZWxzKCk6IElneEV4cGFuc2lvblBhbmVsQ29tcG9uZW50W10ge1xuICAgICAgICByZXR1cm4gdGhpcy5fcGFuZWxzPy50b0FycmF5KCk7XG4gICAgfVxuXG4gICAgQENvbnRlbnRDaGlsZHJlbihJZ3hFeHBhbnNpb25QYW5lbENvbXBvbmVudClcbiAgICBwcml2YXRlIF9wYW5lbHMhOiBRdWVyeUxpc3Q8SWd4RXhwYW5zaW9uUGFuZWxDb21wb25lbnQ+O1xuICAgIHByaXZhdGUgX2FuaW1hdGlvblNldHRpbmdzITogVG9nZ2xlQW5pbWF0aW9uU2V0dGluZ3M7XG4gICAgcHJpdmF0ZSBfZXhwYW5kZWRQYW5lbHMhOiBTZXQ8SWd4RXhwYW5zaW9uUGFuZWxDb21wb25lbnQ+O1xuICAgIHByaXZhdGUgX2V4cGFuZGluZ1BhbmVscyE6IFNldDxJZ3hFeHBhbnNpb25QYW5lbENvbXBvbmVudD47XG4gICAgcHJpdmF0ZSBfZGVzdHJveSQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuICAgIHByaXZhdGUgX3Vuc3ViQ2hpbGRyZW4kID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcbiAgICBwcml2YXRlIF9lbmFibGVkUGFuZWxzITogSWd4RXhwYW5zaW9uUGFuZWxDb21wb25lbnRbXTtcbiAgICBwcml2YXRlIF9zaW5nbGVCcmFuY2hFeHBhbmQgPSBmYWxzZTtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgY2RyOiBDaGFuZ2VEZXRlY3RvclJlZikgeyB9XG5cbiAgICAvKiogQGhpZGRlbiBAaW50ZXJuYWwgKiovXG4gICAgcHVibGljIG5nQWZ0ZXJDb250ZW50SW5pdCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy51cGRhdGVQYW5lbHNBbmltYXRpb24oKTtcbiAgICAgICAgaWYgKHRoaXMuc2luZ2xlQnJhbmNoRXhwYW5kKSB7XG4gICAgICAgICAgICB0aGlzLmNvbGxhcHNlQWxsRXhjZXB0TGFzdCgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqIEBoaWRkZW4gQGludGVybmFsICoqL1xuICAgIHB1YmxpYyBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuX2V4cGFuZGVkUGFuZWxzID0gbmV3IFNldDxJZ3hFeHBhbnNpb25QYW5lbENvbXBvbmVudD4odGhpcy5fcGFuZWxzLmZpbHRlcihwYW5lbCA9PiAhcGFuZWwuY29sbGFwc2VkKSk7XG4gICAgICAgIHRoaXMuX2V4cGFuZGluZ1BhbmVscyA9IG5ldyBTZXQ8SWd4RXhwYW5zaW9uUGFuZWxDb21wb25lbnQ+KCk7XG4gICAgICAgIHRoaXMuX3BhbmVscy5jaGFuZ2VzLnBpcGUodGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3kkKSkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuc3ViVG9DaGFuZ2VzKCk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnN1YlRvQ2hhbmdlcygpO1xuICAgIH1cblxuICAgIC8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xuICAgIHB1YmxpYyBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fdW5zdWJDaGlsZHJlbiQubmV4dCgpO1xuICAgICAgICB0aGlzLl91bnN1YkNoaWxkcmVuJC5jb21wbGV0ZSgpO1xuICAgICAgICB0aGlzLl9kZXN0cm95JC5uZXh0KCk7XG4gICAgICAgIHRoaXMuX2Rlc3Ryb3kkLmNvbXBsZXRlKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRXhwYW5kcyBhbGwgY29sbGFwc2VkIGV4cGFuc2lvbiBwYW5lbHMuXG4gICAgICpcbiAgICAgKiBgYGB0eXBlc2NyaXB0XG4gICAgICogYWNjb3JkaW9uLmV4cGFuZEFsbCgpO1xuICAgICAqIGBgYFxuICAgICAqL1xuICAgIHB1YmxpYyBleHBhbmRBbGwoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLnNpbmdsZUJyYW5jaEV4cGFuZCkge1xuICAgICAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHRoaXMucGFuZWxzLmxlbmd0aCAtIDE7IGkrKykge1xuICAgICAgICAgICAgICAgIHRoaXMucGFuZWxzW2ldLmNvbGxhcHNlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLl9wYW5lbHMubGFzdC5leHBhbmQoKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMucGFuZWxzLmZvckVhY2gocGFuZWwgPT4gcGFuZWwuZXhwYW5kKCkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENvbGxhcHNlcyBhbGwgZXhwYW5kZWQgZXhwYW5zaW9uIHBhbmVscy5cbiAgICAgKlxuICAgICAqIGBgYHR5cGVzY3JpcHRcbiAgICAgKiBhY2NvcmRpb24uY29sbGFwc2VBbGwoKTtcbiAgICAgKiBgYGBcbiAgICAgKi9cbiAgICBwdWJsaWMgY29sbGFwc2VBbGwoKTogdm9pZCB7XG4gICAgICAgIHRoaXMucGFuZWxzLmZvckVhY2gocGFuZWwgPT4gcGFuZWwuY29sbGFwc2UoKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjb2xsYXBzZUFsbEV4Y2VwdExhc3QoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGxhc3RFeHBhbmRlZCA9IHRoaXMucGFuZWxzPy5maWx0ZXIocCA9PiAhcC5jb2xsYXBzZWQgJiYgIXAuaGVhZGVyLmRpc2FibGVkKS5wb3AoKTtcbiAgICAgICAgdGhpcy5wYW5lbHM/LmZvckVhY2goKHA6IElneEV4cGFuc2lvblBhbmVsQ29tcG9uZW50KSA9PiB7XG4gICAgICAgICAgICBpZiAocCAhPT0gbGFzdEV4cGFuZGVkICYmICFwLmhlYWRlci5kaXNhYmxlZCkge1xuICAgICAgICAgICAgICAgIHAuY29sbGFwc2VkID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cdFx0dGhpcy5jZHIuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlS2V5ZG93bihldmVudDogS2V5Ym9hcmRFdmVudCwgcGFuZWw6IElneEV4cGFuc2lvblBhbmVsQ29tcG9uZW50KTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGtleSA9IGV2ZW50LmtleS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICBpZiAoIShBQ0NPUkRJT05fTkFWSUdBVElPTl9LRVlTLmhhcyhrZXkpKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIC8vIFRPIERPOiBpZiB3ZSBldmVyIHdhbnQgdG8gaW1wcm92ZSB0aGUgcGVyZm9ybWFuY2Ugb2YgdGhlIGFjY29yZGlvbixcbiAgICAgICAgLy8gZW5hYmxlZFBhbmVscyBjb3VsZCBiZSBjYWNoZWQgKGJ5IG1ha2luZyBhIGRpc2FibGVkQ2hhbmdlIGVtaXR0ZXIgb24gdGhlIHBhbmVsIGhlYWRlcilcbiAgICAgICAgdGhpcy5fZW5hYmxlZFBhbmVscyA9IHRoaXMuX3BhbmVscy5maWx0ZXIocCA9PiAhcC5oZWFkZXIuZGlzYWJsZWQpO1xuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICB0aGlzLmhhbmRsZU5hdmlnYXRpb24oZXZlbnQsIHBhbmVsKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZU5hdmlnYXRpb24oZXZlbnQ6IEtleWJvYXJkRXZlbnQsIHBhbmVsOiBJZ3hFeHBhbnNpb25QYW5lbENvbXBvbmVudCk6IHZvaWQge1xuICAgICAgICBzd2l0Y2ggKGV2ZW50LmtleS50b0xvd2VyQ2FzZSgpKSB7XG4gICAgICAgICAgICBjYXNlICdob21lJzpcbiAgICAgICAgICAgICAgICB0aGlzLl9lbmFibGVkUGFuZWxzWzBdLmhlYWRlci5pbm5lckVsZW1lbnQuZm9jdXMoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ2VuZCc6XG4gICAgICAgICAgICAgICAgdGhpcy5fZW5hYmxlZFBhbmVsc1t0aGlzLl9lbmFibGVkUGFuZWxzLmxlbmd0aCAtIDFdLmhlYWRlci5pbm5lckVsZW1lbnQuZm9jdXMoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ2Fycm93dXAnOlxuICAgICAgICAgICAgY2FzZSAndXAnOlxuICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlVXBEb3duQXJyb3codHJ1ZSwgZXZlbnQsIHBhbmVsKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ2Fycm93ZG93bic6XG4gICAgICAgICAgICBjYXNlICdkb3duJzpcbiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZVVwRG93bkFycm93KGZhbHNlLCBldmVudCwgcGFuZWwpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVVcERvd25BcnJvdyhpc1VwOiBib29sZWFuLCBldmVudDogS2V5Ym9hcmRFdmVudCwgcGFuZWw6IElneEV4cGFuc2lvblBhbmVsQ29tcG9uZW50KTogdm9pZCB7XG4gICAgICAgIGlmICghZXZlbnQuYWx0S2V5KSB7XG4gICAgICAgICAgICBjb25zdCBmb2N1c2VkUGFuZWwgPSBwYW5lbDtcbiAgICAgICAgICAgIGNvbnN0IG5leHQgPSB0aGlzLmdldE5leHRQYW5lbChmb2N1c2VkUGFuZWwsIGlzVXAgPyAtMSA6IDEpO1xuICAgICAgICAgICAgaWYgKG5leHQgPT09IGZvY3VzZWRQYW5lbCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG5leHQuaGVhZGVyLmlubmVyRWxlbWVudC5mb2N1cygpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChldmVudC5hbHRLZXkgJiYgZXZlbnQuc2hpZnRLZXkpIHtcbiAgICAgICAgICAgIGlmIChpc1VwKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fZW5hYmxlZFBhbmVscy5mb3JFYWNoKHAgPT4gcC5jb2xsYXBzZSgpKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuc2luZ2xlQnJhbmNoRXhwYW5kKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCB0aGlzLl9lbmFibGVkUGFuZWxzLmxlbmd0aCAtIDE7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fZW5hYmxlZFBhbmVsc1tpXS5jb2xsYXBzZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2VuYWJsZWRQYW5lbHNbdGhpcy5fZW5hYmxlZFBhbmVscy5sZW5ndGggLSAxXS5leHBhbmQoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLl9lbmFibGVkUGFuZWxzLmZvckVhY2gocCA9PiBwLmV4cGFuZCgpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0TmV4dFBhbmVsKHBhbmVsOiBJZ3hFeHBhbnNpb25QYW5lbENvbXBvbmVudCwgZGlyOiAxIHwgLTEgPSAxKTogSWd4RXhwYW5zaW9uUGFuZWxDb21wb25lbnQge1xuICAgICAgICBjb25zdCBwYW5lbEluZGV4ID0gdGhpcy5fZW5hYmxlZFBhbmVscy5pbmRleE9mKHBhbmVsKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VuYWJsZWRQYW5lbHNbcGFuZWxJbmRleCArIGRpcl0gfHwgcGFuZWw7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdWJUb0NoYW5nZXMoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuX3Vuc3ViQ2hpbGRyZW4kLm5leHQoKTtcbiAgICAgICAgdGhpcy5fcGFuZWxzLmZvckVhY2gocGFuZWwgPT4ge1xuICAgICAgICAgICAgcGFuZWwuY29udGVudEV4cGFuZGVkLnBpcGUodGFrZVVudGlsKHRoaXMuX3Vuc3ViQ2hpbGRyZW4kKSkuc3Vic2NyaWJlKChhcmdzOiBJRXhwYW5zaW9uUGFuZWxFdmVudEFyZ3MpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLl9leHBhbmRlZFBhbmVscy5hZGQoYXJncy5vd25lcik7XG4gICAgICAgICAgICAgICAgdGhpcy5fZXhwYW5kaW5nUGFuZWxzLmRlbGV0ZShhcmdzLm93bmVyKTtcbiAgICAgICAgICAgICAgICBjb25zdCBldkFyZ3M6IElBY2NvcmRpb25FdmVudEFyZ3MgPSB7IC4uLmFyZ3MsIG93bmVyOiB0aGlzLCBwYW5lbDogYXJncy5vd25lciB9O1xuICAgICAgICAgICAgICAgIHRoaXMucGFuZWxFeHBhbmRlZC5lbWl0KGV2QXJncyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHBhbmVsLmNvbnRlbnRFeHBhbmRpbmcucGlwZSh0YWtlVW50aWwodGhpcy5fdW5zdWJDaGlsZHJlbiQpKS5zdWJzY3JpYmUoKGFyZ3M6IElFeHBhbnNpb25QYW5lbENhbmNlbGFibGVFdmVudEFyZ3MpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoYXJncy5jYW5jZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjb25zdCBldkFyZ3M6IElBY2NvcmRpb25DYW5jZWxhYmxlRXZlbnRBcmdzID0geyAuLi5hcmdzLCBvd25lcjogdGhpcywgcGFuZWw6IGFyZ3Mub3duZXIgfTtcbiAgICAgICAgICAgICAgICB0aGlzLnBhbmVsRXhwYW5kaW5nLmVtaXQoZXZBcmdzKTtcbiAgICAgICAgICAgICAgICBpZiAoZXZBcmdzLmNhbmNlbCkge1xuICAgICAgICAgICAgICAgICAgICBhcmdzLmNhbmNlbCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuc2luZ2xlQnJhbmNoRXhwYW5kKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2V4cGFuZGVkUGFuZWxzLmZvckVhY2gocCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXAuaGVhZGVyLmRpc2FibGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5jb2xsYXBzZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZXhwYW5kaW5nUGFuZWxzLmZvckVhY2gocCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXAuaGVhZGVyLmRpc2FibGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFwLmFuaW1hdGlvblNldHRpbmdzLmNsb3NlQW5pbWF0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAub3BlbkFuaW1hdGlvblBsYXllcj8ucmVzZXQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFwLmFuaW1hdGlvblNldHRpbmdzLm9wZW5BbmltYXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5jbG9zZUFuaW1hdGlvblBsYXllcj8ucmVzZXQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5jb2xsYXBzZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZXhwYW5kaW5nUGFuZWxzLmFkZChhcmdzLm93bmVyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHBhbmVsLmNvbnRlbnRDb2xsYXBzZWQucGlwZSh0YWtlVW50aWwodGhpcy5fdW5zdWJDaGlsZHJlbiQpKS5zdWJzY3JpYmUoKGFyZ3M6IElFeHBhbnNpb25QYW5lbEV2ZW50QXJncykgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuX2V4cGFuZGVkUGFuZWxzLmRlbGV0ZShhcmdzLm93bmVyKTtcbiAgICAgICAgICAgICAgICB0aGlzLl9leHBhbmRpbmdQYW5lbHMuZGVsZXRlKGFyZ3Mub3duZXIpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGV2QXJnczogSUFjY29yZGlvbkV2ZW50QXJncyA9IHsgLi4uYXJncywgb3duZXI6IHRoaXMsIHBhbmVsOiBhcmdzLm93bmVyIH07XG4gICAgICAgICAgICAgICAgdGhpcy5wYW5lbENvbGxhcHNlZC5lbWl0KGV2QXJncyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHBhbmVsLmNvbnRlbnRDb2xsYXBzaW5nLnBpcGUodGFrZVVudGlsKHRoaXMuX3Vuc3ViQ2hpbGRyZW4kKSkuc3Vic2NyaWJlKChhcmdzOiBJRXhwYW5zaW9uUGFuZWxDYW5jZWxhYmxlRXZlbnRBcmdzKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgZXZBcmdzOiBJQWNjb3JkaW9uQ2FuY2VsYWJsZUV2ZW50QXJncyA9IHsgLi4uYXJncywgb3duZXI6IHRoaXMsIHBhbmVsOiBhcmdzLm93bmVyIH07XG4gICAgICAgICAgICAgICAgdGhpcy5wYW5lbENvbGxhcHNpbmcuZW1pdChldkFyZ3MpO1xuICAgICAgICAgICAgICAgIGlmIChldkFyZ3MuY2FuY2VsKSB7XG4gICAgICAgICAgICAgICAgICAgIGFyZ3MuY2FuY2VsID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGZyb21FdmVudChwYW5lbC5oZWFkZXIuaW5uZXJFbGVtZW50LCAna2V5ZG93bicpXG4gICAgICAgICAgICAgICAgLnBpcGUodGFrZVVudGlsKHRoaXMuX3Vuc3ViQ2hpbGRyZW4kKSlcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKChlOiBLZXlib2FyZEV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlS2V5ZG93bihlLCBwYW5lbCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgdXBkYXRlUGFuZWxzQW5pbWF0aW9uKCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5hbmltYXRpb25TZXR0aW5ncyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLnBhbmVscz8uZm9yRWFjaChwYW5lbCA9PiBwYW5lbC5hbmltYXRpb25TZXR0aW5ncyA9IHRoaXMuYW5pbWF0aW9uU2V0dGluZ3MpO1xuICAgICAgICB9XG4gICAgfVxufVxuIl19